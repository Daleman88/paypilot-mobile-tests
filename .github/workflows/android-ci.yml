# El nombre de nuestro flujo de trabajo. Aparecerá en la pestaña "Actions" de GitHub.
name: Android CI - Run Appium Tests

# Define CUÁNDO se debe ejecutar este flujo de trabajo.
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

# Define los "trabajos" (jobs) que se van a realizar.
jobs:
  run-tests:
    # macOS es necesario para la aceleración de hardware del emulador de Android en GitHub.
    runs-on: macos-latest

    steps:
      # 1. Descargar nuestro código del repositorio.
      - name: Check out repository
        uses: actions/checkout@v4

      # 2. Configurar el entorno de Java (necesitamos JDK 11).
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      # 3. Cachear las dependencias de Maven para ganar velocidad.
      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # 4. Iniciar el servidor Appium en segundo plano.
      - name: Start Appium Server
        run: |
          npm install -g appium
          appium &

      # 5. Iniciar el Emulador Y ejecutar las pruebas (TODO EN UNO).
      # Esta acción descarga, configura, arranca el emulador, ejecuta el script y luego limpia.
      - name: Run Android Emulator and Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          target: google_apis
          arch: x86_64
          # Desactivar animaciones hace que las pruebas sean mucho más estables en CI.
          disable-animations: true
          # Opciones para que el emulador corra sin interfaz y de forma eficiente.
          emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim
          # ¡ESTA ES LA CLAVE!: Maven debe ejecutarse AQUÍ dentro mientras el emulador está vivo.
          script: mvn test
        continue-on-error: true

      # 6. Subir los Artefactos de Prueba (Reportes y capturas).
      - name: Upload Test Reports
        if: always() # Queremos el reporte incluso si los tests fallaron.
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: reports/
